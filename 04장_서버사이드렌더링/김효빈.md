# 04장

## 4.1 서버 사이드 렌더링이란?

## 4.1.1 싱글 페이지 애플리케이션의 세상
### 싱글 페이지 애플리케이션이란?
렌더링과 라우팅에 필요한 대부분의 기능을 서버가 아닌 브라우저의 자바스크립트에 의존하는 방식
최초에 서버에서 최소한의 데이터를 불러온 이후부터는 이미 가지고 있는  자바스크립트 리소스와 브라우저 API를 기반으로 모든 작동이 이뤄짐

## 4.1.2 서버 사이드 렌더링이란?
최초에 사용자에게 보여줄 페이지를 서버에서 렌더링해 빠르게 사용자에게 화면을 제공하는 방식을 의미

### 서버 사이드 렌더링의 장점
최초 페이지 진입이 비교적 빠르다
검색 엔진과 sns 공유 등 메타데이터 제공이 쉽다
누적 레이아웃 이동이 적다
사용자의 디바이스 성능에 비교적 자유롭다
보안에 좀 더 안전하다

### 서버 사이드 렌더링의 단점
소스코드를 작성할 때 항상 서버를 고려해야 한다
적절한 서버가 구축돼 있어야 한다
서비스 지연에 따른 문제

## 4.2 서버 사이드 렌더링을 위한 리액트 API 살펴보기
## 4.2.1 renderToString
인수로 넘겨받은 리액트 컴포넌트를 렌더링해 HTML 문자로 반환하는 함수
리액트의 서버 사이드 렌더링은 단순히 ‘최초 HTML 페이지를 빠르게 그려주는 데'에 목적이 있음

## 4.2.2 renderToStaticMarkup
renderToString과 매우 유사한 함수 
두 함수 모두 리액트 컴포넌트를 기준으로 HTML 문자열을 만든다는 점이 동일
renderToStaticMarkup은 리액트의 이벤트 리스너가 필요 없는 완전히 순수한 HTML을 만들 때 사용됨. 블로그 글이나 상품의 약관 정보와 같이 아무런 브라우저 액션이 없는 정적인 내용만 필요한 경우에 유용

## 4.2.3 renderToNodeStream
renderToString과 renderToStaticMarkup은 브라우저에서도 실행할 수 있지만 renderToNodeStream은 브라우저에서 사용하는 것이 완전히 불가능
renderToNodeStream의 결과물은 Node.js의 ReadableStream임, Node.js 환경에서만 사용할 수 있음

### renderToNodeStream은 왜 필요할까?
먼저 스트림이란 큰 데이터를 다룰 때 데이터를 청크(작은 단위)로 분할해 조금씩 가져오는 방식
스트림을 활용한다면 브라우저에게 제공해야할 큰 HTML을 작은 단위로 쪼개 연속적으로 작성함으로써 리액트 애플리케이션을 렌더링하는 Node.js 서버의 부담을 덜 수 있음

## 4.2.4 renderToStaticNodeStream
renderToNodeStream과 제공하는 결과물은 동일하나 renderToStaticMarkup과 마찬가지로 리액트 자바스크립트에 필요한 리액트 속성이 제공되지 않음. hydrate를 할 필요가 없는 순수 HTML 결과물이 필요할 때 사용하는 메서드

## 4.2.5 hydrate
renderToString과 renderToNodeStream으로 생성된 HTML 콘텐츠에 자바스크립트 핸들런나 인벤트를 붙이는 역할을 함
hydrate는 정적으로 생성된 HTML에 이벤트와 핸들러를 붙여 완전한 웹페이지 결과물을 만든다.

hydrate는 render와 인수를 넘기는 것이 거의 유사
render와의 차이점은 hydrate는 기본적으로 이미 렌더링된 HTML이 있다는 가정하에 작업이 수행되고 이 렌더링된 HTML을 기준으로 이벤트를 붙이는 작업만 실행 된다는 것.

서버 사이드 렌더링의 장점, 즉 사용자에게 더 빠른 웹페이지 결과물을 제공할 수 있다는 장점 이면에는 서버가 있으며, 이 서버라는 존재 자체가 개발자에게 더욱 부담이 됨. 또한 서버에서 HMTL을 제공하는 것 뿐만 아니라 번들링된 자바스크립트 소스도 제공해야 하며 적절하게 캐시도 사용해야 하는 등 많은 것들을 고려해야 함

## 4.3 Next.js 톺아보기

## 4.3.1 Next.js란?
Vercel이라는 미국 스타트업에서 만든 리액트 기반 서버 사이드 렌더링 프레임워크, PHP에 영감을 받아 만들어짐

## 4.3.2 Next.js 시작하기
_app.tsx는 Next.js를 초기화하는 파일로 Next.js 설정과 관련된 코드를 모아두는 곳이며 경우에 따라 서버와 클라이언트 모두에서 렌더링될 수 있음
_document.tsx는 Next.js로 만드는 웹사이트의 뼈대가 되는 HTML 설정과 코드를 추가하는 곳이며 반드시 서버에서만 렌더링 됨
Next.js는 react-pages처럼 라우팅 구조는 다음과 같이 /pages 디렉터리를 기초로 구성되며 각 페이지에 있는 default export로 내보낸 함수가 해당 페이지의 루프 컴포넌트가 됨
파일 이름이 곧 라우팅 되는 것, [] 안의 내용은 변수로 처리된다는 점

### 서버 라우팅과 클라이언트 라우팅의 차이
Next.js는 서버 사이드 렌더링을 수행하지만 동시에 싱글 페이지 애플리케이션과 같이 클라이언트 라우팅 또한 수행함. 
Next.js는 서버 사이드 렌더링의 장점, 즉 사용자가 빠르게 볼 수 있는 최초 페이지를 제공한다는 점과 싱글 페이지 애플리케이션의 장점인 자연스러운 라우팅이라는 두 가지 장점을 모두 살리기 위해 이러한 방식으로 작동한다는 것.

Next.js의 장점을 적극 살리기 위해서는 내부 페이지 이동 시 다음과 같은 규칙을 지켜야 함
<a> 대신 <Link>를 사용
window.location.push 대신 router.push를 사용

## 4.3.3 Data Fetching
Next.js에서는 서버 사이드 렌더링 지원을 위한 몇 가지 데이터 불러오기 전략이 있는데 이를 Next.js에서는 Data Fetching이라고 함
이 함수는 pages/의 폴더에 있는 라우팅이 되는 파일에서만 사용할 수 있으며 예약어로 지정되어 반드시 정해진 함수명으로 export를 사용해 함수를 파일 외부로 내보내야 함

### getStaticPath와 getStaticProps
이 두 함수는 어떠한 페이지를 CMS(Contents Management System)나 블로그, 게시판과 같이 사용자와 관계없이 정적으로 결정된 페이지를 보여주고 할 때 사용되는 함수
getStaticPaths 함수의 반환값 중 하나인 fallback 옵션은 이렇게 미리 빌드해야 할 페이지가 너무 많은 경우에 사용 가능

### getServerSideProps
서버에서 실행되는 함수이며 해당 함수가 있다면 무조건 페이지 진입 전에 이 함수를 실행
이 함수는 응답값에 따라 페이지의 루트 컴포넌트에 props를 반환할 수도 혹은 다른 페이지로 리다이렉트시킬 수도 있음

서버에서 실행되기 때문에 다음과 같은 제약이 있음
window.document와 같이 브라우저에서만 접근할 수 있는 객체에는 접근할 수 없음
API 호출시 /api/some/path와 같이 protocol과 domain 없이 fetch 요청을 할 수 없다. 브라우저와 다르게 서버는 자신의 호스트를 유추할 수 없기 때문. 반드시 완전한 주소를 제공해야 fetch가 가능
여기에서 에러가 발생한다면 500.tsx와 같이 이미리 정의해 둔 에러 페이지로 리다이렉트됨

이 함수는 사용자가 매 페이지를 호출할 때마다 실행되고 이 실행이 끝나기 전까지는 사용자에게 어떠한 HTML도 보여줄 수 없음
getServerSideProps에는 반드시 해당 페이지를 렌더링하는 데 있어 중요한 역할을 하는 데이터만 가져오는 것이 좋음

### getInitialProps
getInitialProps는 getStaticProps나 getServerSideProps가 나오기 전에 사용할 수 있었던 유일한 페이지 데이터 불러오기 수단이었음. getInitialProps는 굉장히 제한적인 예시에서만 사용됨
getInitialProps는 라우팅에 따라서 서버와 클라이언트 모두에서 실행 가능한 메서드
가급적 getStaticProps나 getServerSideProps를 사용하는 편이 좋고 getInitialProps는 _app.tsx나 _error.tsx와 같이 Next.js의 특성상 사용이 제한돼 있는 페이지에서만 사용하는 것이 좋음

## 4.3.4 스타일 적용하기
웹 애플리케이션을 만들 때 빼놓을 수 없는 것 중 하나가 스타일 즉, CSS(Cascading Style Sheets)
Next.js에서는 다양한 방식의 스타일을 대부분 지원

## 4.3.5 _app.tsx 응용하기
_app.tsx가 Next.js로 만든 모든 서비스가 진입하는 최초 진입점
웹서비스를 최초에 접근했을 대만 실행하고 싶은 내용을 app.getInitialProps 내부에 담아 둘 수 있음

## 4.3.6 next.config.js 살펴보기
Next.js 실행에 필요한 설정을 추가할 수 있는 파일

